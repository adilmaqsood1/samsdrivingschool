{% extends "admin/base.html" %}
{% load i18n %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a></h1>
{% endblock %}

{% block extrastyle %}{{ block.super }}
<style>
#admin-notifications-link{position:relative;display:inline-block;margin-right:6px}
#admin-notifications-link .admin-notifications-badge{position:absolute;top:-6px;right:-10px;min-width:16px;height:16px;line-height:16px;border-radius:8px;background:#d9534f;color:#fff;font-size:11px;text-align:center;padding:0 4px;display:none}
#admin-notifications-link .icon-new{font-size:14px}
</style>
{% endblock %}

{% block userlinks %}
{% url 'admin:crm_notificationreceipt_changelist' as notif_changelist %}
<a href="{{ notif_changelist }}?user__id__exact={{ user.id }}&read_at__isnull=True" id="admin-notifications-link"><span class="icon-new"></span><span class="admin-notifications-badge" id="admin-notifications-badge"></span></a> /
{{ block.super }}
{% endblock %}

{% block extrahead %}{{ block.super }}
<script>
(function(){
  function updateBadge(){
    fetch("{% url 'notifications_unread_count' %}", {credentials:'same-origin'})
      .then(function(r){return r.ok ? r.json(): null;})
      .then(function(data){
        if(!data){return;}
        var badge=document.getElementById('admin-notifications-badge');
        if(!badge){return;}
        var n=parseInt(data.unread_count||0,10);
        if(n>0){
          badge.textContent = n>99 ? '99+' : String(n);
          badge.style.display='inline-block';
        } else {
          badge.textContent='';
          badge.style.display='none';
        }
      })
      .catch(function(){});
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){updateBadge(); setInterval(updateBadge, 30000);});
  } else {
    updateBadge(); setInterval(updateBadge, 30000);
  }
})();
</script>
{% endblock %}
